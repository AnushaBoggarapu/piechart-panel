{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":";;;;;AAKe,WAAS,IAAT,CAAc,KAAd,EAAqB,IAArB,EAA2B,KAA3B,EAAkC,IAAlC,EAAwC;AACrD,QAAI,IAAJ,EAAU,KAAV,CADqD;AAErD,WAAO,KAAK,IAAL,CAAU,wBAAV,CAAP,CAFqD;AAGrD,QAAI,WAAW,EAAE,oBAAF,CAAX,CAHiD;;AAKrD,SAAK,MAAL,CAAY,EAAZ,CAAe,QAAf,EAAyB,YAAY;AACnC,aAAO,KAAP,EADmC;AAEnC,UAAI,MAAM,UAAN,KAAqB,YAArB,EAAmC;AACrC,mBAAW,YAAY;AAAE,iBAAO,IAAP,EAAF;SAAZ,EAA+B,EAA1C,EADqC;OAAvC;KAFuB,CAAzB,CALqD;;AAYrD,aAAS,eAAT,CAAyB,WAAzB,EAAsC;AACpC,UAAI,CAAC,KAAK,KAAL,CAAW,MAAX,CAAkB,IAAlB,IAA0B,KAAK,KAAL,CAAW,UAAX,KAA0B,YAA1B,IAA0C,KAAK,KAAL,CAAW,UAAX,KAA0B,UAA1B,EAAsC;AAC7G,eAAO,CAAP,CAD6G;OAA/G;;AAIA,UAAI,KAAK,KAAL,CAAW,UAAX,IAAyB,aAAzB,IAA0C,KAAK,KAAL,CAAW,MAAX,CAAkB,UAAlB,IAAgC,KAAK,KAAL,CAAW,MAAX,CAAkB,MAAlB,EAA0B;AACtG,YAAI,aAAa,SAAS,KAAK,KAAL,CAAW,UAAX,CAAT,GAAgC,GAAhC,CADqF;AAEtG,YAAI,QAAQ,KAAK,KAAK,KAAK,MAAL,CAFgF;AAGtG,eAAO,KAAK,GAAL,CAAS,KAAT,EAAgB,KAAK,KAAL,CAAW,cAAc,UAAd,CAA3B,CAAP,CAHsG;OAAxG;KALF;;AAYA,aAAS,SAAT,CAAmB,KAAnB,EAA0B,KAA1B,EAAiC;AAC/B,UAAI,aAAa,MAAM,IAAN,CAAW,CAAX,EAAc,MAAM,IAAN,CAAW,CAAX,EAAc,MAAd,GAAuB,CAAvB,CAA3B,CAD2B;AAE/B,UAAI,UAAU,CAAV,CAF2B;AAG/B,UAAI,QAAQ,2BAA2B,KAAK,KAAL,CAAW,QAAX,GAAsB,uCAAjD,GAA2F,MAAM,KAAN,GAAc,KAAzG,GAAiH,KAAjH,GAAyH,OAAzH,CAHmB;;AAK/B,UAAG,KAAK,KAAL,CAAW,MAAX,CAAkB,kBAAlB,EAAsC;AACvC,kBAAU,KAAK,KAAL,CAAW,MAAX,CAAkB,kBAAlB,CAD6B;OAAzC;AAGA,UAAI,KAAK,KAAL,CAAW,MAAX,CAAkB,MAAlB,IAA4B,KAAK,KAAL,CAAW,MAAX,CAAkB,UAAlB,EAA8B;AAC5D,eAAO,QAAQ,KAAK,WAAL,CAAiB,UAAjB,CAAR,GAAuC,OAAvC,GAAiD,MAAM,OAAN,CAAc,OAAd,CAAsB,OAAtB,CAAjD,GAAkF,SAAlF,CADqD;OAA9D,MAEO,IAAI,KAAK,KAAL,CAAW,MAAX,CAAkB,MAAlB,EAA0B;AACnC,eAAO,QAAQ,KAAK,WAAL,CAAiB,UAAjB,CAAR,GAAuC,QAAvC,CAD4B;OAA9B,MAEA,IAAI,KAAK,KAAL,CAAW,MAAX,CAAkB,UAAlB,EAA8B;AACvC,eAAO,QAAQ,MAAM,OAAN,CAAc,OAAd,CAAsB,OAAtB,CAAR,GAAyC,SAAzC,CADgC;OAAlC,MAEA;AACL,eAAO,QAAQ,QAAR,CADF;OAFA;KAZT;;AAmBA,aAAS,YAAT,GAAwB;AACtB,UAAI,OAAO,iFAAP,CADkB;AAEtB,WAAK,IAAL,CAAU,IAAV,EAFsB;KAAxB;;AAKA,aAAS,WAAT,GAAuB;AACrB,UAAI,QAAQ,KAAK,KAAL,EAAR,CADiB;AAErB,UAAI,SAAS,KAAK,MAAL,GAAc,gBAAgB,KAAK,MAAL,CAA9B,CAFQ;;AAIrB,UAAI,OAAO,KAAK,GAAL,CAAS,KAAT,EAAgB,MAAhB,CAAP,CAJiB;;AAMrB,UAAI,aAAa,EAAE,aAAF,CAAb,CANiB;AAOrB,UAAI,UAAU;AACZ,gBAAQ,MAAR;AACA,kBAAU,UAAV;AACA,uBAAe,KAAK,IAAL;AACf,gBAAQ,OAAO,IAAP;OAJN,CAPiB;;AAcrB,iBAAW,GAAX,CAAe,OAAf,EAdqB;;AAgBrB,UAAI,kBAAkB,EAAE,MAAF,EAAU,GAAV,CAAc,kBAAd,CAAlB,CAhBiB;;AAkBrB,UAAI,UAAU;AACZ,gBAAQ;AACN,gBAAM,KAAN;SADF;AAGA,gBAAQ;AACN,eAAK;AACH,kBAAM,IAAN;AACA,oBAAQ;AACN,qBAAO,eAAP;AACA,qBAAO,WAAW,KAAK,KAAL,CAAW,WAAX,CAAX,CAAmC,OAAnC,CAA2C,CAA3C,CAAP;aAFF;AAIA,mBAAO;AACL,oBAAM,KAAK,KAAL,CAAW,MAAX,CAAkB,IAAlB,IAA0B,KAAK,KAAL,CAAW,UAAX,KAA0B,UAA1B;AAChC,yBAAW,SAAX;aAFF;AAIA,uBAAW;AACT,uBAAS,GAAT;aADF;AAGA,qBAAS;AACP,yBAAW,KAAK,KAAL,CAAW,OAAX,CAAmB,SAAnB;AACX,qBAAO,KAAK,KAAL,CAAW,OAAX,CAAmB,KAAnB;aAFT;WAbF;SADF;AAoBA,cAAM;AACJ,qBAAW,IAAX;AACA,qBAAW,KAAX;SAFF;OAxBE,CAlBiB;;AAgDrB,UAAI,MAAM,OAAN,KAAkB,OAAlB,EAA2B;AAC7B,gBAAQ,MAAR,CAAe,GAAf,CAAmB,WAAnB,GAAiC,GAAjC,CAD6B;OAA/B;;AAIA,aAAO,KAAK,IAAL,CApDc;;AAsDrB,WAAK,IAAI,IAAI,CAAJ,EAAO,IAAI,KAAK,MAAL,EAAa,GAAjC,EAAsC;AACpC,YAAI,SAAS,KAAK,CAAL,CAAT;;;AADgC,YAIhC,KAAK,YAAL,CAAkB,OAAO,KAAP,CAAtB,EAAqC;AACnC,iBAAO,IAAP,GAAc,EAAd,CADmC;SAArC;OAJF;;AAUA,UAAI,MAAM,MAAN,CAAa,IAAb,EAAmB;AACrB,YAAI,KAAK,KAAL,CAAW,SAAX,KAAyB,MAAM,MAAN,CAAa,IAAb,EAAmB;AAC9C,gBAAM,MAAN,CAAa,IAAb,GAAoB,KAAK,KAAL,CAAW,SAAX,CAD0B;SAAhD;AAGA,YAAI,MAAM,MAAN,CAAa,QAAb,KAA0B,IAA1B,EAAgC;AAClC,eAAK,IAAL,CAAU,UAAU,CAAV,EAAa,CAAb,EAAgB;AACxB,mBAAO,EAAE,UAAF,GAAe,EAAE,UAAF,CADE;WAAhB,CAAV,CADkC;SAApC,MAIO;AACL,eAAK,IAAL,CAAU,UAAU,CAAV,EAAa,CAAb,EAAgB;AACxB,mBAAO,EAAE,UAAF,GAAe,EAAE,UAAF,CADE;WAAhB,CAAV,CADK;SAJP;OAJF;;AAeA,WAAK,IAAL,CAAU,UAAV,EA/EqB;;AAiFrB,QAAE,IAAF,CAAO,UAAP,EAAmB,IAAnB,EAAyB,OAAzB,EAjFqB;AAkFrB,iBAAW,IAAX,CAAgB,WAAhB,EAA6B,UAAU,KAAV,EAAiB,GAAjB,EAAsB,IAAtB,EAA4B;AACvD,YAAI,CAAC,IAAD,EAAO;AACT,mBAAS,MAAT,GADS;AAET,iBAFS;SAAX;;AAKA,YAAI,IAAJ,CANuD;AAOvD,YAAI,UAAU,WAAW,KAAK,MAAL,CAAY,OAAZ,CAAX,CAAgC,OAAhC,CAAwC,CAAxC,CAAV,CAPmD;AAQvD,YAAI,YAAY,KAAK,WAAL,CAAiB,KAAK,MAAL,CAAY,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,CAAjB,CAAZ,CARmD;;AAUvD,eAAO,yEAAP,CAVuD;AAWvD,gBAAQ,yCAAyC,KAAK,MAAL,CAAY,KAAZ,GAAoB,IAA7D,GAAoE,SAApE,CAX+C;AAYvD,gBAAQ,OAAO,OAAP,GAAiB,IAAjB,GAAwB,QAAxB,CAZ+C;AAavD,gBAAQ,cAAR,CAbuD;;AAevD,iBAAS,IAAT,CAAc,IAAd,EAAoB,QAApB,CAA6B,IAAI,KAAJ,GAAY,EAAZ,EAAgB,IAAI,KAAJ,CAA7C,CAfuD;OAA5B,CAA7B,CAlFqB;KAAvB;;AAqGA,aAAS,MAAT,CAAgB,sBAAhB,EAAwC;AACtC,UAAI,CAAC,KAAK,IAAL,EAAW;AAAE,eAAF;OAAhB;;AAEA,aAAO,KAAK,IAAL,CAH+B;AAItC,cAAQ,KAAK,KAAL,CAJ8B;;AAQpC,UAAI,KAAK,KAAK,IAAL,CAAU,MAAV,EAAkB;AACzB,uBADyB;OAA3B,MAEO;AACL,sBADK;OAFP;;AAQF,UAAI,sBAAJ,EAA4B;AAC1B,aAAK,kBAAL,GAD0B;OAA5B;KAhBF;GArJa;;qBAAS;;;;AALjB;;AACA","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel__chart');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function () {\n    render(false);\n    if (panel.legendType === 'Right side') {\n      setTimeout(function () { render(true); }, 50);\n    }\n  });\n\n  function getLegendHeight(panelHeight) {\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' || ctrl.panel.legendType === 'On graph') {\n      return 0;\n    }\n\n    if (ctrl.panel.legendType == 'Under graph' && ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\n      let breakPoint = parseInt(ctrl.panel.breakPoint)/100;\n      var total = 23 + 20 * data.length;\n      return Math.min(total, Math.floor(panelHeight * breakPoint));\n    }\n  }\n\n  function formatter(label, slice) {\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if(ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = ctrl.height - getLegendHeight(ctrl.height);\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      margin: 'auto',\n      position: 'relative',\n      paddingBottom: 20 + 'px',\n      height: size + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n          combine: {\n            threshold: ctrl.panel.combine.threshold,\n            label: ctrl.panel.combine.label\n          }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: false\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    data = ctrl.data;\n\n    for (let i = 0; i < data.length; i++) {\n      let series = data[i];\n\n      // if hidden remove points\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n      }\n    }\n\n\n    if (panel.legend.sort) {\n      if (ctrl.panel.valueName !== panel.legend.sort) {\n        panel.legend.sort = ctrl.panel.valueName;\n      }\n      if (panel.legend.sortDesc === true) {\n        data.sort(function (a, b) {\n          return b.legendData - a.legendData;\n        });\n      } else {\n        data.sort(function (a, b) {\n          return a.legendData - b.legendData;\n        });\n      }\n    }\n\n    elem.html(plotCanvas);\n\n    $.plot(plotCanvas, data, options);\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\n      if (!item) {\n        $tooltip.detach();\n        return;\n      }\n\n      var body;\n      var percent = parseFloat(item.series.percent).toFixed(2);\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n      body = '<div class=\"piechart-tooltip-small\"><div class=\"piechart-tooltip-time\">';\n      body += '<div class=\"piechart-tooltip-value\">' + item.series.label + ': ' + formatted;\n      body += \" (\" + percent + \"%)\" + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n    });\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n\n\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addPieChart();\n      }\n\n\n\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}