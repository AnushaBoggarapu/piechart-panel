{"version":3,"sources":["../src/legend.js"],"names":[],"mappings":"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","file":"legend.js","sourcesContent":["import angular from \"angular\";\nimport kbn from \"app/core/utils/kbn\";\nimport $ from \"jquery\";\nimport \"jquery.flot\";\nimport \"jquery.flot.time\";\nimport PerfectScrollbar from \"./lib/perfect-scrollbar.min\";\n\nangular\n  .module(\"grafana.directives\")\n  .directive(\"piechartLegend\", function(popoverSrv, $timeout) {\n    return {\n      link: function(scope, elem) {\n        var $container = $('<div class=\"piechart-legend__container\"></div>');\n        var firstRender = true;\n        var ctrl = scope.ctrl;\n        var panel = ctrl.panel;\n        var data;\n        var seriesList;\n        var dataList;\n        var i;\n        var legendScrollbar;\n\n        scope.$on(\"$destroy\", function() {\n          if (legendScrollbar) {\n            legendScrollbar.destroy();\n          }\n        });\n\n        ctrl.events.on(\"render\", function() {\n          data = ctrl.series;\n          if (data) {\n              for (var i in data) {\n                data[i].color = ctrl.data[i].color;\n              }\n            render();\n          }\n        });\n\n        function getSeriesIndexForElement(el) {\n          return el.parents(\"[data-series-index]\").data(\"series-index\");\n        }\n\n        function toggleSeries(e) {\n          var el = $(e.currentTarget);\n          var index = getSeriesIndexForElement(el);\n          var seriesInfo = dataList[index];\n          var scrollPosition = $($container.children(\"tbody\")).scrollTop();\n          ctrl.toggleSeries(seriesInfo);\n          $($container.children(\"tbody\")).scrollTop(scrollPosition);\n        }\n\n        function sortLegend(e) {\n          var el = $(e.currentTarget);\n          var stat = el.data(\"stat\");\n\n          if (stat !== panel.legend.sort) {\n            panel.legend.sortDesc = null;\n          }\n\n          // if already sort ascending, disable sorting\n          if (panel.legend.sortDesc === false) {\n            panel.legend.sort = null;\n            panel.legend.sortDesc = null;\n            ctrl.render();\n            return;\n          }\n\n          panel.legend.sortDesc = !panel.legend.sortDesc;\n          panel.legend.sort = stat;\n          ctrl.render();\n        }\n\n        function getLegendHeaderHtml(statName) {\n          var name = statName;\n\n          if (panel.legend.header) {\n            name = panel.legend.header;\n          }\n\n          var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n          if (panel.legend.sort === statName) {\n            var cssClass = panel.legend.sortDesc\n              ? \"fa fa-caret-down\"\n              : \"fa fa-caret-up\";\n            html += ' <span class=\"' + cssClass + '\"></span>';\n          }\n\n          return html + \"</th>\";\n        }\n\n        function getLegendPercentageHtml(statName) {\n          var name = \"percentage\";\n          var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n          if (panel.legend.sort === statName) {\n            var cssClass = panel.legend.sortDesc\n              ? \"fa fa-caret-down\"\n              : \"fa fa-caret-up\";\n            html += ' <span class=\"' + cssClass + '\"></span>';\n          }\n\n          return html + \"</th>\";\n        }\n\n        function openColorSelector(e) {\n          // if we clicked inside poup container ignore click\n          if ($(e.target).parents(\".popover\").length) {\n            return;\n          }\n\n          var el = $(e.currentTarget).find(\".fa-minus\");\n          var index = getSeriesIndexForElement(el);\n          var series = seriesList[index];\n\n          $timeout(function() {\n            popoverSrv.show({\n              element: el[0],\n              position: \"bottom center\",\n              template:\n                '<series-color-picker series=\"series\" onToggleAxis=\"toggleAxis\" onColorChange=\"colorSelected\">' +\n                \"</series-color-picker>\",\n              openOn: \"hover\",\n              model: {\n                autoClose: true,\n                series: series,\n                toggleAxis: function() {},\n                colorSelected: function(color) {\n                  ctrl.changeSeriesColor(series, color);\n                }\n              }\n            });\n          });\n        }\n\n        function render() {\n          if (panel.legendType === \"On graph\") {\n            $container.empty();\n            $(\".piechart-legend\").css(\"padding-top\", 0);\n            return;\n          } else {\n            $(\".piechart-legend\").css(\"padding-top\", 6);\n          }\n\n          if (firstRender) {\n            elem.append($container);\n            $container.on(\"click\", \".piechart-legend-icon\", openColorSelector);\n            $container.on(\"click\", \".piechart-legend-alias\", toggleSeries);\n            $container.on(\"click\", \"th\", sortLegend);\n            firstRender = false;\n          }\n\n          seriesList = data;\n          dataList = ctrl.data;\n\n          $container.empty();\n\n          var width =\n            panel.legendType == \"Right side\" && panel.legend.sideWidth\n              ? panel.legend.sideWidth + \"px\"\n              : \"\";\n          $container.css(\"min-width\", width);\n\n          var showValues = panel.legend.values || panel.legend.percentage;\n          var tableLayout =\n            (panel.legendType === \"Under graph\" ||\n              panel.legendType === \"Right side\") &&\n            showValues;\n\n          $container.toggleClass(\"piechart-legend-table\", tableLayout);\n\n          var legendHeader;\n          if (tableLayout) {\n            var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n            if (panel.legend.values) {\n              header += getLegendHeaderHtml(ctrl.panel.valueName);\n            }\n            if (panel.legend.percentage) {\n              header += getLegendPercentageHtml(ctrl.panel.valueName);\n            }\n            header += \"</tr>\";\n            legendHeader = $(header);\n          }\n\n          if (panel.legend.percentage) {\n            var total = 0;\n            for (i = 0; i < seriesList.length; i++) {\n              total += seriesList[i].stats[ctrl.panel.valueName];\n            }\n          }\n\n          var seriesShown = 0;\n          var seriesElements = [];\n\n          for (i = 0; i < seriesList.length; i++) {\n            var series = seriesList[i];\n            var seriesData = dataList[i];\n\n            // ignore empty series\n            if (panel.legend.hideEmpty && series.allIsNull) {\n              continue;\n            }\n            // ignore series excluded via override\n            if (!series.legend) {\n              continue;\n            }\n\n            var decimal = 2;\n            if (ctrl.panel.legend.percentageDecimals) {\n              decimal = ctrl.panel.legend.percentageDecimals;\n            }\n\n            var html = '<div class=\"piechart-legend-series';\n            if (ctrl.hiddenSeries[seriesData.label]) {\n              html += \" piechart-legend-series-hidden\";\n            }\n            html += '\" data-series-index=\"' + i + '\">';\n            html += '<span class=\"piechart-legend-icon\" style=\"float:none;\">';\n            html +=\n              '<i class=\"fa fa-minus pointer\" style=\"color:' +\n              seriesData.color +\n              '\"></i>';\n            html += \"</span>\";\n\n            html +=\n              '<a class=\"piechart-legend-alias\" style=\"float:none;\">' +\n              seriesData.label +\n              \"</a>\";\n\n            if (showValues && tableLayout) {\n              var value = seriesData.legendData;\n              if (panel.legend.values) {\n                html +=\n                  '<div class=\"piechart-legend-value\">' +\n                  ctrl.formatValue(value) +\n                  \"</div>\";\n              }\n              if (total) {\n                var pvalue = (value / total * 100).toFixed(decimal) + \"%\";\n                html += '<div class=\"piechart-legend-value\">' + pvalue + \"</div>\";\n              }\n            }\n\n            html += \"</div>\";\n\n            seriesElements.push($(html));\n            seriesShown++;\n          }\n          if (tableLayout) {\n            var topPadding = 6;\n            var tbodyElem = $(\"<tbody></tbody>\");\n            // tbodyElem.css(\"max-height\", maxHeight - topPadding);\n            tbodyElem.append(legendHeader);\n            tbodyElem.append(seriesElements);\n            $container.append(tbodyElem);\n          } else {\n            $container.append(seriesElements);\n          }\n\n          if (panel.legendType === \"Under graph\") {\n            addScrollbar();\n          } else {\n            destroyScrollbar();\n          }\n        }\n        function addScrollbar() {\n          const scrollbarOptions = {\n            // Number of pixels the content height can surpass the container height without enabling the scroll bar.\n            scrollYMarginOffset: 2,\n            suppressScrollX: true\n          };\n\n          if (!legendScrollbar) {\n            legendScrollbar = new PerfectScrollbar(\n              \".piechart-legend\",\n              scrollbarOptions\n            );\n          } else {\n            legendScrollbar.update();\n          }\n        }\n\n        function destroyScrollbar() {\n          if (legendScrollbar) {\n            legendScrollbar.destroy();\n            legendScrollbar = null;\n          }\n        }\n      }\n    };\n  });\n"]}